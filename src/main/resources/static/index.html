<script>
const API_CHAT = "/api/chat";
const API_THEME = "/api/theme";

const bubble = document.getElementById("chatBubble");
const windowBox = document.getElementById("chatWindow");
const closeBtn = document.getElementById("closeChat");
const messages = document.getElementById("chatMessages");
const input = document.getElementById("input");
const send = document.getElementById("send");

/**
 * Apply CSS variables from a theme object
 */
function applyTheme(theme) {
    if (!theme) return;

    const root = document.documentElement;
    root.style.setProperty('--chat-header', theme.headerColor);
    root.style.setProperty('--chat-bg', theme.backgroundColor);
    root.style.setProperty('--chat-text', theme.textColor);
    root.style.setProperty('--chat-icon', theme.iconColor);

    root.style.setProperty('--chat-chip-bg', theme.chipBackgroundColor || '#f0f0f0');
    root.style.setProperty('--chat-chip-hover', theme.chipHoverColor || '#e0e0e0');
    root.style.setProperty('--chat-chip-border', theme.chipBorderColor || '#ccc');

    // Update avatar if exists
    const avatars = document.querySelectorAll(".chatbot-avatar");
    avatars.forEach(img => {
        if (theme.avatarFilename) {
            img.src = theme.avatarFilename;
            img.style.display = 'inline-block';
        } else {
            img.style.display = 'none';
        }
    });
}

/**
 * Fetch and apply user theme
 */
async function loadTheme() {
    try {
        const res = await fetch(API_THEME);
        if (!res.ok) throw new Error("Failed to load theme");
        const theme = await res.json();
        applyTheme(theme);
    } catch (err) {
        console.error("Error loading theme:", err);
    }
}

// Initial theme load
loadTheme();

// Chat bubble open/close
bubble.onclick = () => { windowBox.style.display = "flex"; bubble.style.display = "none"; };
closeBtn.onclick = () => { windowBox.style.display = "none"; bubble.style.display = "flex"; };

// Add message to chat
function addMsg(text, cls) {
    const div = document.createElement("div");
    div.className = `msg ${cls}`;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
}

// Send chat message
async function sendMsg(textOverride) {
    const text = textOverride || input.value.trim();
    if (!text) return;

    addMsg(text, "user");
    input.value = "";

    const loading = addMsg("Thinkingâ€¦", "bot");

    try {
        const res = await fetch(API_CHAT, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: text
        });
        const reply = await res.text();
        loading.textContent = reply || "No response.";
    } catch (err) {
        console.error("Chat fetch error:", err);
        loading.textContent = "Server error.";
    }
}

// Event listeners
send.onclick = () => sendMsg();
input.addEventListener("keydown", e => { if(e.key==="Enter"){ e.preventDefault(); sendMsg(); } });
document.querySelectorAll(".chip").forEach(chip => {
    chip.onclick = () => {
        sendMsg(chip.textContent);
        document.getElementById("suggestions").style.display = "none";
    };
});
</script>
